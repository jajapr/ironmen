AmCharts.AmExport=AmCharts.Class({construct:function(t,e,o){var r=this;r.DEBUG=!1,r.chart=t,r.canvas=null,r.svgs=[],r.userCFG=e,r.buttonIcon="export.png",r.exportPNG=!0,r.exportPDF=!1,r.exportJPG=!1,r.exportSVG=!1,r.right=0,r.top=0,r.buttonRollOverColor="#EFEFEF",r.textRollOverColor="#CC0000",r.buttonTitle="Save chart as an image",r.buttonAlpha=.75,r.imageFileName="amChart",r.imageBackgroundColor="#FFFFFF",o&&r.init()},toCoordinate:function(t){return void 0===t?"auto":-1!=String(t).indexOf("%")?t:t+"px"},init:function(){var t=this,e=[];t.exportPNG&&e.push("png"),t.exportPDF&&e.push("pdf"),t.exportJPG&&e.push("jpg"),t.exportSVG&&e.push("svg");var o=[];if(1==e.length){var r=e[0];o.push({format:r,iconTitle:t.buttonTitle,icon:t.chart.pathToImages+t.buttonIcon})}else if(e.length>1){for(var n=[],a=0;a<e.length;a++)n.push({format:e[a],title:e[a].toUpperCase()});o.push({onclick:function(){},icon:t.chart.pathToImages+t.buttonIcon,items:n})}var i=t.color;void 0===i&&(i=t.chart.color);var s=t.buttonColor;void 0===s&&(s="transparent"),t.cfg={menuTop:t.toCoordinate(t.top),menuLeft:t.toCoordinate(t.left),menuRight:t.toCoordinate(t.right),menuBottom:t.toCoordinate(t.bottom),menuItems:o,menuItemStyle:{backgroundColor:s,opacity:t.buttonAlpha,rollOverBackgroundColor:t.buttonRollOverColor,color:i,rollOverColor:t.textRollOverColor,paddingTop:"6px",paddingRight:"6px",paddingBottom:"6px",paddingLeft:"6px",marginTop:"0px",marginRight:"0px",marginBottom:"0px",marginLeft:"0px",textAlign:"left",textDecoration:"none",fontFamily:t.chart.fontFamily,fontSize:t.chart.fontSize+"px"},menuItemOutput:{backgroundColor:t.imageBackgroundColor,fileName:t.imageFileName,format:"png",output:"dataurlnewwindow",render:"browser",dpi:90,onclick:function(t,e,o){o.preventDefault(),t.output(e)}},removeImagery:!0},t.processing={buffer:[],drawn:0,timer:0},"undefined"!=typeof window.canvg&&"undefined"!=typeof window.RGBColor&&(t.cfg.menuItemOutput.render="canvg"),"undefined"!=typeof window.saveAs&&(t.cfg.menuItemOutput.output="save"),AmCharts.isIE&&AmCharts.IEversion<10&&(t.cfg.menuItemOutput.output="dataurlnewwindow");var g=t.userCFG;g&&(g.menuItemOutput=AmCharts.extend(t.cfg.menuItemOutput,g.menuItemOutput||{}),g.menuItemStyle=AmCharts.extend(t.cfg.menuItemStyle,g.menuItemStyle||{}),t.cfg=AmCharts.extend(t.cfg,g)),t.chart.AmExport=t,t.chart.addListener("rendered",function(){t.setup()}),t.DEBUG&&(window.AmExport=t)},log:function(){console.log("AmExport: ",arguments)},setup:function(){var t=this;(!AmCharts.isIE||AmCharts.isIE&&AmCharts.IEversion>9)&&t.generateButtons()},generateBinaryArray:function(t){for(var e,o,r,n=t.length,a=new Uint8Array(n/4*3|0),i=0,s=0,g=[0,0],l=0,u=0,d=new Uint8Array([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51]);n--;)o=t.charCodeAt(i++),e=d[o-43],255!==e&&e!==r&&(g[1]=g[0],g[0]=o,u=u<<6|e,l++,4===l&&(a[s++]=u>>>16,61!==g[1]&&(a[s++]=u>>>8),61!==g[0]&&(a[s++]=u),l=0));return a},generateBlob:function(t,e){var o=this,r="image/svg+xml"!=e?t.indexOf(",")+1:0,n=t.substring(0,r),a=t,i=new Blob;return-1!=n.indexOf("base64")&&(a=o.generateBinaryArray(t.substring(r))),AmCharts.isIE&&AmCharts.IEversion<10?(i.data=a,i.size=a.length,i.type=e,i.encoding="base64"):i=new Blob([a],{type:e}),i},generatePDF:function(t){var e=this,o={output:function(){return""}},r=e.canvas.toDataURL("image/jpeg"),n=25.4*e.canvas.width/t.dpi,a=25.4*e.canvas.height/t.dpi;return window.jsPDF?(o=new jsPDF,o.addImage?o.addImage(r,"JPEG",0,0,n,a):alert("Missing jsPDF plugin; Please add the 'addImage' plugin.")):alert("Missing jsPDF lib; Don't forget to add the addImage plugin."),o},output:function(t,e){function o(){var o,n=null;"image/svg+xml"==t.format||"svg"==t.format?(n=r.generateSVG(),o=r.generateBlob(n,"image/svg+xml"),"save"==t.output?saveAs(o,t.fileName+".svg"):"datastring"==t.output||"datauristring"==t.output||"dataurlstring"==t.output?o="data:image/svg+xml;base64,"+btoa(n):"dataurlnewwindow"==t.output?window.open("data:image/svg+xml;base64,"+btoa(n)):"datauri"==t.output||"dataurl"==t.output?location.href="data:image/svg+xml;base64,"+btoa(n):"datastream"==t.output&&(location.href="data:image/octet-stream;base64,"+n),e&&e.apply(r,[o])):"application/pdf"==t.format||"pdf"==t.format?(n=r.generatePDF(t).output("dataurlstring"),o=r.generateBlob(n,"application/pdf"),"save"==t.output?saveAs(o,t.fileName+".pdf"):"datastring"==t.output||"datauristring"==t.output||"dataurlstring"==t.output?o=n:"dataurlnewwindow"==t.output?window.open(n):"datauri"==t.output||"dataurl"==t.output?location.href=n:"datastream"==t.output&&(location.href=n.replace("application/pdf","application/octet-stream")),e&&e.apply(r,[o])):"image/png"==t.format||"png"==t.format?(n=r.canvas.toDataURL("image/png"),o=r.generateBlob(n,"image/png"),"save"==t.output?saveAs(o,t.fileName+".png"):"datastring"==t.output||"datauristring"==t.output||"dataurlstring"==t.output?o=n:"dataurlnewwindow"==t.output?window.open(n):"datauri"==t.output||"dataurl"==t.output?location.href=n:"datastream"==t.output&&(location.href=n.replace("image/png","image/octet-stream")),e&&e.apply(r,[o])):("image/jpeg"==t.format||"jpeg"==t.format||"jpg"==t.format)&&(n=r.canvas.toDataURL("image/jpeg"),o=r.generateBlob(n,"image/jpeg"),"save"==t.output?saveAs(o,t.fileName+".jpg"):"datastring"==t.output||"datauristring"==t.output||"dataurlstring"==t.output?o=n:"dataurlnewwindow"==t.output?window.open(n):"datauri"==t.output||"dataurl"==t.output?location.href=n:"datastream"==t.output&&(location.href=n.replace("image/jpeg","image/octet-stream")),e&&e.apply(r,[o]))}var r=this;return t=AmCharts.extend(AmCharts.extend({},r.cfg.menuItemOutput),t||{}),r.chart.prepareForExport&&r.chart.prepareForExport(),r.generateOutput(t,o)},polifySVG:function(t){function e(t,e){for(var r=t.getElementsByTagName(e),n=r.length;n--;)if(o.cfg.removeImagery)r[n].parentNode.removeChild(r[n]);else{var a=document.createElement("img"),i=document.createElement("canvas"),s=i.getContext("2d");i.width=r[n].getAttribute("width"),i.height=r[n].getAttribute("height"),a.src=r[n].getAttribute("xlink:href"),a.width=r[n].getAttribute("width"),a.height=r[n].getAttribute("height");try{s.drawImage(a,0,0,a.width,a.height),datastring=i.toDataURL()}catch(t){throw datastring=a.src,o.log("Tainted canvas, reached browser CORS security; origin from imagery must be equal to the server!"),new Error(t)}r[n].setAttribute("xlink:href",datastring)}}var o=this;return 0==AmCharts.IEversion&&(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),o.cfg.removeImagery||t.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink")),e(t,"pattern"),e(t,"image"),o.svgs.push(t),t},generateSVG:function(){var t=this,e=document.createElement("svg");e.setAttribute("xmlns","http://www.w3.org/2000/svg"),e.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");for(var o=0;o<t.processing.buffer.length;o++){var r=document.createElement("g"),n=t.processing.buffer[o];n[0].setAttribute("xmlns","http://www.w3.org/2000/svg"),n[0].setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),r.setAttribute("transform","translate("+n[1].x+","+n[1].y+")"),r.appendChild(n[0]),e.appendChild(r)}return(new XMLSerializer).serializeToString(e)},generateOutput:function(t,e){function o(){var n,a,g,l;return r.processing.buffer.length==r.processing.drawn||"svg"==t.format?e():(a=r.processing.buffer[r.processing.drawn],l=(new XMLSerializer).serializeToString(a[0]),g=a[1],"browser"==t.render?(n=new Image,n.id=AmCharts.getUniqueId(),l="data:image/svg+xml;base64,"+btoa(l),n.onload=function(){s.drawImage(this,a[1].x,a[1].y),r.processing.drawn++,o()},n.onerror=function(){s.drawImage(this,a[1].x,a[1].y),r.processing.drawn++,o()},n.src=l,(n.complete||"undefined"==typeof n.complete||void 0===n.complete)&&(n.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",n.src=l)):"canvg"==t.render&&canvg(i,l,{offsetX:g.x,offsetY:g.y,ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,renderCallback:function(){r.processing.drawn++,o()}}),void 0)}for(var r=this,n=[],a=[],i=document.createElement("canvas"),s=i.getContext("2d"),g={y:0,x:0},n=r.chart.div.getElementsByTagName("svg"),l=0;l<n.length;l++)a.push(n[l]);r.chart.legend&&"outside"==r.chart.legend.position&&(r.chart.legend.container.container.externalLegend=!0,a.push(r.chart.legend.container.container),"left"==r.cfg.legendPosition?g.x=r.chart.legend.div.offsetWidth:"top"==r.cfg.legendPosition?g.y=r.chart.legend.div.offsetHeight:"object"==typeof r.cfg.legendPosition&&(g.y=r.cfg.legendPosition.chartTop,g.x=r.cfg.legendPosition.chartLeft)),r.processing.buffer=[],r.processing.drawn=0,r.canvas=i,r.svgs=[];for(var u={x:0,y:0},l=0;l<a.length;l++){var d=a[l].parentNode,c=Number(d.style.left.slice(0,-2)),p=Number(d.style.top.slice(0,-2)),m=r.polifySVG(a[l].cloneNode(!0)),h=AmCharts.extend({},g);a[l].externalLegend?"right"==r.cfg.legendPosition?(g.y=0,g.x=r.chart.divRealWidth):"bottom"==r.cfg.legendPosition?g.y=p?p:g.y:"object"==typeof r.cfg.legendPosition?(g.x=r.cfg.legendPosition.left,g.y=r.cfg.legendPosition.top):(g.x=0,g.y=0):"relative"==d.style.position?(g.x=c?c:g.x,g.y=p?p:g.y):(g.x=c+u.x,g.y=p+u.y),r.processing.buffer.push([m,AmCharts.extend({},g)]),p&&c?g=h:g.y+=p?0:d.offsetHeight,"absolute"==d.style.position&&"amChartsLegend"==d.getAttribute("class")&&(u.y+=d.parentNode.offsetHeight)}i.id=AmCharts.getUniqueId(),i.width=r.chart.divRealWidth,i.height=r.chart.divRealHeight,r.chart.legend&&"outside"==r.chart.legend.position&&(-1!=["left","right"].indexOf(r.cfg.legendPosition)?i.width+=r.chart.legend.div.offsetWidth:"object"==typeof r.cfg.legendPosition?(i.width+=r.cfg.legendPosition.width,i.height+=r.cfg.legendPosition.height):i.height+=r.chart.legend.div.offsetHeight);var f={width:!1,height:!1};return r.chart.periodSelector&&(-1!=["left","right"].indexOf(r.chart.periodSelector.position)?(i.width-=r.chart.periodSelector.div.offsetWidth+16,f.width=!0):(i.height-=r.chart.periodSelector.div.offsetHeight,f.height=!0)),r.chart.dataSetSelector&&(-1!=["left","right"].indexOf(r.chart.dataSetSelector.position)?f.width||(i.width-=r.chart.dataSetSelector.div.offsetWidth+16):i.height-=r.chart.dataSetSelector.div.offsetHeight),(t.backgroundColor||"image/jpeg"==t.format)&&(s.fillStyle=t.backgroundColor||"#FFFFFF",s.fillRect(0,0,i.width,i.height)),o()},generateButtons:function(){function t(e){var n=document.createElement("ul");n.setAttribute("style","list-style: none; margin: 0; padding: 0;");for(var a=0;a<e.length;a++){var i=document.createElement("li"),s=document.createElement("img"),g=document.createElement("a"),l=e[a],u=null,d=AmCharts.extend(AmCharts.extend({},o.cfg.menuItemStyle),e[a]);l=AmCharts.extend(AmCharts.extend({},o.cfg.menuItemOutput),l),l.icon&&(s.alt="",s.src=l.icon,s.setAttribute("style","margin: 0 auto;border: none;outline: none"),l.iconTitle&&(s.title=l.iconTitle),g.appendChild(s)),g.href="#",l.title&&(s.setAttribute("style","margin: 0px 5px;"),g.innerHTML+=l.title),g.setAttribute("style","display: block;"),AmCharts.extend(g.style,d),g.onclick=l.onclick.bind(g,o,l),i.appendChild(g),l.items&&(u=t(l.items),i.appendChild(u),i.onmouseover=function(){u.style.display="block"},i.onmouseout=function(){u.style.display="none"},u.style.display="none"),n.appendChild(i),g.onmouseover=function(){this.style.backgroundColor=d.rollOverBackgroundColor,this.style.color=d.rollOverColor,this.style.borderColor=d.rollOverBorderColor},g.onmouseout=function(){this.style.backgroundColor=d.backgroundColor,this.style.color=d.color,this.style.borderColor=d.borderColor}}return r++,n}var e,o=this,r=0;o.div?(e=o.div,e.innerHTML=""):(e=document.createElement("div"),o.div=e),e.setAttribute("style","position: absolute;top:"+o.cfg.menuTop+";right:"+o.cfg.menuRight+";bottom:"+o.cfg.menuBottom+";left:"+o.cfg.menuLeft+";"),e.setAttribute("class","amExportButton"),e.appendChild(t(o.cfg.menuItems)),o.chart.containerDiv.appendChild(e)}});